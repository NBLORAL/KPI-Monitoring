<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KPI Monitoring System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&amp;family=Inter:wght@400;500;600&amp;display=swap" rel="stylesheet">
  <style>
    html, body {
      height: 100%;
      box-sizing: border-box;
    }
    * {
      font-family: 'Inter', sans-serif;
    }
    h1, h2, h3, .font-display {
      font-family: 'Space Grotesk', sans-serif;
    }
    
    :root {
      --bg-primary: #f8fafc;
      --bg-secondary: #ffffff;
      --bg-tertiary: #e2e8f0;
      --text-primary: #0f172a;
      --text-secondary: #64748b;
      --border: #cbd5e1;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --success: #10b981;
      --error: #ef4444;
      --warning: #f59e0b;
    }
    
    body.dark-mode {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --border: #475569;
    }
    
    body {
      background-color: var(--bg-primary);
      color: var(--text-primary);
      transition: all 0.3s ease;
    }
    
    .card {
      background-color: var(--bg-secondary);
      border: 1px solid var(--border);
      transition: all 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 40px -10px rgba(59, 130, 246, 0.3);
    }
    
    .btn-primary {
      background-color: var(--accent);
      color: white;
      transition: all 0.2s ease;
    }
    
    .btn-primary:hover {
      background-color: var(--accent-hover);
    }
    
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .progress-bar {
      background: linear-gradient(90deg, var(--accent), var(--success));
      transition: width 0.5s ease;
    }
    
    .modal-overlay {
      animation: fadeIn 0.2s ease;
    }
    
    .modal-content {
      animation: slideUp 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    
    .toast {
      animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
    }
    
    input, select, textarea {
      background-color: var(--bg-tertiary);
      border-color: var(--border);
      color: var(--text-primary);
      transition: all 0.2s ease;
    }
    
    input::placeholder, textarea::placeholder {
      color: var(--text-secondary);
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
    }
    
    .page {
      display: none;
    }
    
    .page.active {
      display: block;
    }
    
    .spinner {
      border: 3px solid var(--bg-tertiary);
      border-top: 3px solid var(--accent);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-state {
      pointer-events: none;
      opacity: 0.6;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full w-full">
  <div id="app" class="h-full w-full flex flex-col lg:flex-row overflow-hidden"><!-- Sidebar -->
   <aside class="lg:w-64 w-full card border-r lg:border-b-0 border-b flex lg:flex-col flex-row h-auto lg:h-full overflow-x-auto lg:overflow-auto">
    <div class="p-4 lg:p-6 border-b lg:border-r border-transparent flex-shrink-0 lg:border-b-0" style="border-color: var(--border);">
     <h1 id="app-title" class="font-display text-lg lg:text-xl font-bold whitespace-nowrap">KPI Monitor</h1>
     <p id="company-name" class="text-xs lg:text-sm mt-1 whitespace-nowrap" style="color: var(--text-secondary);">Your Company</p>
    </div>
    <nav class="flex lg:flex-col flex-1 lg:flex-none gap-1 lg:gap-0 p-1 lg:p-4 lg:space-y-2 overflow-x-auto lg:overflow-x-visible"><button onclick="navigateTo('dashboard')" class="nav-item flex-shrink-0 lg:w-full text-center lg:text-left px-1.5 lg:px-4 py-1.5 lg:py-3 rounded-lg font-medium transition-all whitespace-nowrap flex flex-col lg:flex-row items-center lg:items-center gap-0.5 lg:gap-3 justify-center lg:justify-start text-xs lg:text-base" data-page="dashboard" style="background-color: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.5);"> <span>üìä</span> <span>Dashboard</span> </button> <button onclick="navigateTo('kpi-update')" class="nav-item flex-shrink-0 lg:w-full text-center lg:text-left px-1.5 lg:px-4 py-1.5 lg:py-3 rounded-lg font-medium transition-all whitespace-nowrap flex flex-col lg:flex-row items-center lg:items-center gap-0.5 lg:gap-3 justify-center lg:justify-start text-xs lg:text-base" data-page="kpi-update" style="color: var(--text-secondary);"> <span>‚ö°</span> <span>Update KPI</span> </button> <button onclick="navigateTo('management')" class="nav-item flex-shrink-0 lg:w-full text-center lg:text-left px-1.5 lg:px-4 py-1.5 lg:py-3 rounded-lg font-medium transition-all whitespace-nowrap flex flex-col lg:flex-row items-center lg:items-center gap-0.5 lg:gap-3 justify-center lg:justify-start text-xs lg:text-base" data-page="management" style="color: var(--text-secondary);"> <span>‚öôÔ∏è</span> <span>Management</span> </button>
    </nav>
    <div class="p-2 lg:p-4 border-l lg:border-l-0 lg:border-t flex-shrink-0" style="border-color: var(--border);"><button onclick="toggleTheme()" class="w-full flex items-center justify-center gap-1 lg:gap-2 px-3 lg:px-4 py-2 rounded-lg font-medium text-xs lg:text-base transition-all" style="background-color: var(--bg-tertiary);"> <span id="theme-icon">üåô</span> <span id="theme-text" class="hidden lg:inline">Dark Mode</span> </button>
    </div>
   </aside><!-- Main Content -->
   <main class="flex-1 overflow-auto h-auto lg:h-full w-full lg:w-auto"><!-- Dashboard Page -->
    <div id="page-dashboard" class="page active p-4 lg:p-8 max-w-7xl mx-auto w-full">
     <div class="mb-6 lg:mb-8">
      <h2 class="font-display text-2xl lg:text-3xl font-bold mb-2">Dashboard</h2>
      <p style="color: var(--text-secondary);" class="text-sm lg:text-base">Monitor KPI performance across team members</p>
     </div><!-- Loading State -->
     <div id="dashboard-loading" class="hidden">
      <div class="flex items-center justify-center py-12">
       <div class="spinner"></div><span class="ml-3 text-sm lg:text-base" style="color: var(--text-secondary);">Loading dashboard...</span>
      </div>
     </div><!-- Stats Grid -->
     <div id="dashboard-content" class="hidden">
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 lg:gap-6 mb-6 lg:mb-8">
       <div class="card rounded-2xl border p-4 lg:p-6">
        <p style="color: var(--text-secondary);" class="text-xs lg:text-sm">üë• Total Members</p>
        <p id="stat-members" class="text-3xl lg:text-4xl font-bold mt-2">0</p>
       </div>
       <div class="card rounded-2xl border p-4 lg:p-6">
        <p style="color: var(--text-secondary);" class="text-xs lg:text-sm">üìä Active KPIs</p>
        <p id="stat-kpis" class="text-3xl lg:text-4xl font-bold mt-2">0</p>
       </div>
       <div class="card rounded-2xl border p-4 lg:p-6">
        <p style="color: var(--text-secondary);" class="text-xs lg:text-sm">üéØ Total Assignments</p>
        <p id="stat-assignments" class="text-3xl lg:text-4xl font-bold mt-2">0</p>
       </div>
      </div><!-- Leaderboard -->
      <div class="card rounded-2xl border p-4 lg:p-6">
       <h3 class="font-display text-lg lg:text-xl font-semibold mb-4 lg:mb-6">üèÜ Leaderboard</h3>
       <div id="leaderboard" class="space-y-2 lg:space-y-3">
        <p class="text-center py-12 text-sm lg:text-base" style="color: var(--text-secondary);">No data yet</p>
       </div>
      </div>
     </div><!-- Error State -->
     <div id="dashboard-error" class="hidden">
      <div class="card rounded-2xl border p-6 lg:p-8 text-center">
       <p style="color: var(--error);" class="text-base lg:text-lg">‚ö†Ô∏è Failed to load dashboard</p><button onclick="loadData()" class="btn-primary mt-4 px-4 lg:px-6 py-2 rounded-lg text-sm lg:text-base">Retry</button>
      </div>
     </div>
    </div><!-- KPI Update Page -->
    <div id="page-kpi-update" class="page p-4 lg:p-8 max-w-7xl mx-auto w-full">
     <div class="mb-6 lg:mb-8">
      <h2 class="font-display text-2xl lg:text-3xl font-bold mb-2">Update KPI</h2>
      <p style="color: var(--text-secondary);" class="text-sm lg:text-base">Track progress on assigned KPIs</p>
     </div>
     <div class="mb-6 max-w-md"><label class="block text-sm font-medium mb-2">Select Member</label> <select id="member-select" onchange="loadMemberKpis()" class="w-full px-4 py-2 lg:py-3 rounded-xl border text-sm lg:text-base"> <option value="">Choose member...</option> </select>
     </div>
     <div id="kpi-update-list" class="space-y-3 lg:space-y-4">
      <p class="text-center py-12 text-sm lg:text-base" style="color: var(--text-secondary);">Select a member to view their KPIs</p>
     </div>
    </div><!-- Management Page -->
    <div id="page-management" class="page p-4 lg:p-8 max-w-7xl mx-auto w-full">
     <h2 class="font-display text-2xl lg:text-3xl font-bold mb-6 lg:mb-8">Management</h2><!-- Tabs -->
     <div class="flex gap-2 lg:gap-4 mb-6 lg:mb-8 border-b overflow-x-auto" style="border-color: var(--border);"><button onclick="switchTab('members')" class="tab-btn active px-3 lg:px-6 py-2 lg:py-3 font-semibold border-b-2 text-sm lg:text-base whitespace-nowrap flex-shrink-0" style="border-color: var(--accent);">Members</button> <button onclick="switchTab('kpis')" class="tab-btn px-3 lg:px-6 py-2 lg:py-3 font-semibold border-b-2 border-transparent text-sm lg:text-base whitespace-nowrap flex-shrink-0" style="color: var(--text-secondary);">KPIs</button> <button onclick="switchTab('assignments')" class="tab-btn px-3 lg:px-6 py-2 lg:py-3 font-semibold border-b-2 border-transparent text-sm lg:text-base whitespace-nowrap flex-shrink-0" style="color: var(--text-secondary);">Assignments</button>
     </div><!-- Members Tab -->
     <div id="tab-members" class="tab-content">
      <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-4 lg:mb-6 gap-3">
       <h3 class="text-lg lg:text-xl font-semibold">Team Members</h3><button onclick="openMemberModal()" class="btn-primary w-full lg:w-auto px-4 lg:px-6 py-2 lg:py-3 rounded-xl font-medium text-sm lg:text-base">+ Add Member</button>
      </div>
      <div id="members-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 lg:gap-6">
       <p class="text-center py-12 col-span-full text-sm lg:text-base" style="color: var(--text-secondary);">No members yet</p>
      </div>
     </div><!-- KPIs Tab -->
     <div id="tab-kpis" class="tab-content hidden">
      <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-4 lg:mb-6 gap-3">
       <h3 class="text-lg lg:text-xl font-semibold">KPI Templates</h3><button onclick="openKpiModal()" class="btn-primary w-full lg:w-auto px-4 lg:px-6 py-2 lg:py-3 rounded-xl font-medium text-sm lg:text-base">+ Add KPI</button>
      </div>
      <div id="kpis-list" class="space-y-3 lg:space-y-4">
       <p class="text-center py-12 text-sm lg:text-base" style="color: var(--text-secondary);">No KPIs yet</p>
      </div>
     </div><!-- Assignments Tab -->
     <div id="tab-assignments" class="tab-content hidden">
      <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-4 lg:mb-6 gap-3">
       <h3 class="text-lg lg:text-xl font-semibold">KPI Assignments</h3><button onclick="openAssignmentModal()" class="btn-primary w-full lg:w-auto px-4 lg:px-6 py-2 lg:py-3 rounded-xl font-medium text-sm lg:text-base">+ Assign KPI</button>
      </div>
      <div id="assignments-list" class="space-y-3 lg:space-y-4">
       <p class="text-center py-12 text-sm lg:text-base" style="color: var(--text-secondary);">No assignments yet</p>
      </div>
     </div>
    </div>
   </main>
  </div><!-- Member Modal -->
  <div id="member-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
   <div class="modal-overlay absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeModal()"></div>
   <div class="modal-content relative w-[95%] sm:w-full max-w-lg card rounded-2xl border p-4 lg:p-8 max-h-[90vh] overflow-auto">
    <div class="flex justify-between items-center mb-4 lg:mb-6">
     <h3 id="member-modal-title" class="text-xl lg:text-2xl font-bold">Add Member</h3><button onclick="closeModal()" style="color: var(--text-secondary);" class="hover:opacity-80 flex-shrink-0">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24">
       <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg></button>
    </div>
    <form id="member-form" class="space-y-3 lg:space-y-4" onsubmit="saveMember(event)"><input type="hidden" id="member-id">
     <div><label class="block text-xs lg:text-sm font-medium mb-1 lg:mb-2">Nama</label> <input type="text" id="member-name" required placeholder="John Doe" class="w-full px-3 lg:px-4 py-2 lg:py-3 rounded-xl border text-sm lg:text-base">
     </div>
     <div><label class="block text-xs lg:text-sm font-medium mb-1 lg:mb-2">Nama Bisnis</label> <input type="text" id="member-business" required placeholder="PT. Maju Jaya" class="w-full px-3 lg:px-4 py-2 lg:py-3 rounded-xl border text-sm lg:text-base">
     </div>
     <div><label class="block text-xs lg:text-sm font-medium mb-1 lg:mb-2">Email</label> <input type="email" id="member-email" required placeholder="john@example.com" class="w-full px-3 lg:px-4 py-2 lg:py-3 rounded-xl border text-sm lg:text-base">
     </div>
     <div><label class="block text-xs lg:text-sm font-medium mb-1 lg:mb-2">No HP</label> <input type="tel" id="member-phone" required placeholder="+62812345678" class="w-full px-3 lg:px-4 py-2 lg:py-3 rounded-xl border text-sm lg:text-base">
     </div>
     <div><label class="block text-xs lg:text-sm font-medium mb-1 lg:mb-2">LinkedIn</label> <input type="url" id="member-linkedin" placeholder="https://linkedin.com/in/username" class="w-full px-3 lg:px-4 py-2 lg:py-3 rounded-xl border text-sm lg:text-base">
     </div>
     <div><label class="block text-xs lg:text-sm font-medium mb-1 lg:mb-2">Instagram</label> <input type="text" id="member-instagram" placeholder="@username" class="w-full px-3 lg:px-4 py-2 lg:py-3 rounded-xl border text-sm lg:text-base">
     </div>
     <div class="flex gap-2 lg:gap-3 pt-2 lg:pt-4"><button type="button" onclick="closeModal()" class="flex-1 px-3 lg:px-6 py-2 lg:py-3 rounded-xl border hover:opacity-80 text-sm lg:text-base">Cancel</button> <button type="submit" class="flex-1 btn-primary px-3 lg:px-6 py-2 lg:py-3 rounded-xl font-medium text-sm lg:text-base">Save</button>
     </div>
    </form>
   </div>
  </div><!-- KPI Modal -->
  <div id="kpi-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
   <div class="modal-overlay absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeModal()"></div>
   <div class="modal-content relative w-[95%] sm:w-full max-w-lg card rounded-2xl border p-4 lg:p-8 max-h-[90vh] overflow-auto">
    <div class="flex justify-between items-center mb-4 lg:mb-6">
     <h3 id="kpi-modal-title" class="text-xl lg:text-2xl font-bold">Add KPI</h3><button onclick="closeModal()" style="color: var(--text-secondary);" class="hover:opacity-80 flex-shrink-0">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24">
       <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg></button>
    </div>
    <form id="kpi-form" class="space-y-3 lg:space-y-4" onsubmit="saveKpi(event)"><input type="hidden" id="kpi-id">
     <div><label class="block text-xs lg:text-sm font-medium mb-1 lg:mb-2">Item</label> <input type="text" id="kpi-item" required placeholder="e.g., Attend Meeting" class="w-full px-3 lg:px-4 py-2 lg:py-3 rounded-xl border text-sm lg:text-base">
     </div>
     <div><label class="block text-xs lg:text-sm font-medium mb-1 lg:mb-2">Kriteria</label> <input type="text" id="kpi-kriteria" required placeholder="e.g., 1 jam/week" class="w-full px-3 lg:px-4 py-2 lg:py-3 rounded-xl border text-sm lg:text-base">
     </div>
     <div><label class="block text-xs lg:text-sm font-medium mb-1 lg:mb-2">Interval</label> <select id="kpi-interval" required class="w-full px-3 lg:px-4 py-2 lg:py-3 rounded-xl border text-sm lg:text-base"> <option value="Daily">Daily</option> <option value="Weekly">Weekly</option> <option value="Monthly">Monthly</option> <option value="Quarterly">Quarterly</option> <option value="Annual">Annual</option> </select>
     </div>
     <div class="flex gap-2 lg:gap-3 pt-2 lg:pt-4"><button type="button" onclick="closeModal()" class="flex-1 px-3 lg:px-6 py-2 lg:py-3 rounded-xl border hover:opacity-80 text-sm lg:text-base">Cancel</button> <button type="submit" class="flex-1 btn-primary px-3 lg:px-6 py-2 lg:py-3 rounded-xl font-medium text-sm lg:text-base">Save</button>
     </div>
    </form>
   </div>
  </div><!-- Assignment Modal -->
  <div id="assignment-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
   <div class="modal-overlay absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeModal()"></div>
   <div class="modal-content relative w-[95%] sm:w-full max-w-lg card rounded-2xl border p-4 lg:p-8 max-h-[90vh] overflow-auto">
    <div class="flex justify-between items-center mb-4 lg:mb-6">
     <h3 class="text-xl lg:text-2xl font-bold">Assign KPI</h3><button onclick="closeModal()" style="color: var(--text-secondary);" class="hover:opacity-80 flex-shrink-0">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24">
       <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg></button>
    </div>
    <form id="assignment-form" class="space-y-3 lg:space-y-4" onsubmit="saveAssignment(event)">
     <div><label class="block text-xs lg:text-sm font-medium mb-1 lg:mb-2">Member</label> <select id="assignment-member" required class="w-full px-3 lg:px-4 py-2 lg:py-3 rounded-xl border text-sm lg:text-base"> <option value="">Choose member...</option> </select>
     </div>
     <div><label class="block text-xs lg:text-sm font-medium mb-1 lg:mb-2">KPI Template</label> <select id="assignment-kpi" required class="w-full px-3 lg:px-4 py-2 lg:py-3 rounded-xl border text-sm lg:text-base"> <option value="">Choose KPI...</option> </select>
     </div>
     <div><label class="block text-xs lg:text-sm font-medium mb-1 lg:mb-2">Target Points</label> <input type="number" id="assignment-target" min="1" max="100" value="20" required class="w-full px-3 lg:px-4 py-2 lg:py-3 rounded-xl border text-sm lg:text-base">
     </div>
     <div class="flex gap-2 lg:gap-3 pt-2 lg:pt-4"><button type="button" onclick="closeModal()" class="flex-1 px-3 lg:px-6 py-2 lg:py-3 rounded-xl border hover:opacity-80 text-sm lg:text-base">Cancel</button> <button type="submit" class="flex-1 btn-primary px-3 lg:px-6 py-2 lg:py-3 rounded-xl font-medium text-sm lg:text-base">Assign</button>
     </div>
    </form>
   </div>
  </div><!-- Toast Container -->
  <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>
  <script>
    // Supabase Config
    const SUPABASE_URL = 'https://wxzuwqwkqezbeoehizck.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind4enV3cXdrcWV6YmVvZWhpemNrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1MDA4NTcsImV4cCI6MjA4MTA3Njg1N30.hc69-2zHx5DwgXfzZc5Aji0_jPEHRNlKBC1a46f82zw';
    
    let supabaseClient = null;
    let members = [];
    let kpis = [];
    let assignments = [];
    let isDarkMode = false;

    // Initialize Element SDK
    if (window.elementSdk) {
      const defaultConfig = { app_title: 'KPI Monitor', company_name: 'Your Company' };
      
      window.elementSdk.init({
        defaultConfig,
        onConfigChange: (config) => {
          document.getElementById('app-title').textContent = config.app_title || 'KPI Monitor';
          document.getElementById('company-name').textContent = config.company_name || 'Your Company';
        },
        mapToCapabilities: () => ({ recolorables: [], borderables: [], fontEditable: undefined, fontSizeable: undefined }),
        mapToEditPanelValues: (config) => new Map([
          ['app_title', config.app_title || 'KPI Monitor'],
          ['company_name', config.company_name || 'Your Company']
        ])
      });
    }

    // Initialize Supabase
    async function initSupabase() {
      if (!window.supabase) {
        showToast('Supabase library not loaded', 'error');
        return false;
      }
      
      try {
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
          auth: { persistSession: false, autoRefreshToken: false },
          realtime: { params: { eventsPerSecond: 10 } }
        });
        
        // Test connection
        const testResult = await supabaseClient.from('members').select('count', { count: 'exact' }).limit(1);
        if (testResult.error && testResult.error.code !== 'PGRST116') {
          throw testResult.error;
        }
        
        showToast('Connected to database ÔøΩÔøΩÔøΩÔøΩÔøΩ', 'success');
        return true;
      } catch (error) {
        console.error('Supabase connection error:', error);
        showToast('Database connection failed', 'error');
        return false;
      }
    }

    // Load Data
    async function loadData() {
      if (!supabaseClient) {
        const connected = await initSupabase();
        if (!connected) {
          showDashboardError();
          return;
        }
      }
      
      try {
        showDashboardLoading();
        
        const [membersRes, kpisRes, assignmentsRes] = await Promise.all([
          supabaseClient.from('members').select('*'),
          supabaseClient.from('kpi_templates').select('*'),
          supabaseClient.from('assignments').select('*')
        ]);
        
        if (membersRes.error) throw membersRes.error;
        if (kpisRes.error) throw kpisRes.error;
        if (assignmentsRes.error) throw assignmentsRes.error;
        
        members = membersRes.data || [];
        kpis = kpisRes.data || [];
        assignments = assignmentsRes.data || [];
        
        renderAll();
        showDashboardContent();
      } catch (error) {
        console.error('Error loading data:', error);
        showToast('Error loading data', 'error');
        showDashboardError();
      }
    }

    // UI State Management
    function showDashboardLoading() {
      document.getElementById('dashboard-loading').classList.remove('hidden');
      document.getElementById('dashboard-content').classList.add('hidden');
      document.getElementById('dashboard-error').classList.add('hidden');
    }

    function showDashboardContent() {
      document.getElementById('dashboard-loading').classList.add('hidden');
      document.getElementById('dashboard-content').classList.remove('hidden');
      document.getElementById('dashboard-error').classList.add('hidden');
    }

    function showDashboardError() {
      document.getElementById('dashboard-loading').classList.add('hidden');
      document.getElementById('dashboard-content').classList.add('hidden');
      document.getElementById('dashboard-error').classList.remove('hidden');
    }

    // Navigation
    function navigateTo(page) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(`page-${page}`).classList.add('active');
      
      document.querySelectorAll('.nav-item').forEach(item => {
        item.style.backgroundColor = '';
        item.style.color = 'var(--text-secondary)';
        item.style.borderColor = '';
      });
      
      const activeNav = document.querySelector(`[data-page="${page}"]`);
      if (activeNav) {
        activeNav.style.backgroundColor = 'rgba(59, 130, 246, 0.2)';
        activeNav.style.borderColor = 'rgba(59, 130, 246, 0.5)';
        activeNav.style.color = 'var(--text-primary)';
      }
    }

    // Tab Switching
    function switchTab(tab) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
      document.getElementById(`tab-${tab}`).classList.remove('hidden');
      
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.style.borderColor = 'transparent';
        btn.style.color = 'var(--text-secondary)';
      });
      
      event.target.style.borderColor = 'var(--accent)';
      event.target.style.color = 'var(--text-primary)';
    }

    // Theme Toggle
    function toggleTheme() {
      isDarkMode = !isDarkMode;
      document.body.classList.toggle('dark-mode', isDarkMode);
      document.getElementById('theme-icon').textContent = isDarkMode ? '‚òÄÔ∏è' : 'üåô';
      document.getElementById('theme-text').textContent = isDarkMode ? 'Light Mode' : 'Dark Mode';
    }

    // Modals
    function openMemberModal() {
      document.getElementById('member-id').value = '';
      document.getElementById('member-form').reset();
      document.getElementById('member-modal-title').textContent = 'Add Member';
      document.getElementById('member-modal').classList.remove('hidden');
    }

    function openKpiModal() {
      document.getElementById('kpi-id').value = '';
      document.getElementById('kpi-form').reset();
      document.getElementById('kpi-modal-title').textContent = 'Add KPI';
      document.getElementById('kpi-modal').classList.remove('hidden');
    }

    function openAssignmentModal() {
      document.getElementById('assignment-form').reset();
      
      const memberSelect = document.getElementById('assignment-member');
      const kpiSelect = document.getElementById('assignment-kpi');
      
      memberSelect.innerHTML = '<option value="">Choose member...</option>';
      kpiSelect.innerHTML = '<option value="">Choose KPI...</option>';
      
      members.forEach(m => memberSelect.innerHTML += `<option value="${m.id}">${m.name}</option>`);
      kpis.forEach(k => kpiSelect.innerHTML += `<option value="${k.id}">${k.item}</option>`);
      
      document.getElementById('assignment-modal').classList.remove('hidden');
    }

    function closeModal() {
      document.querySelectorAll('[id*="-modal"]').forEach(m => m.classList.add('hidden'));
    }

    // Save Functions
    async function saveMember(e) {
      e.preventDefault();
      if (!supabaseClient) {
        showToast('Database not initialized', 'error');
        return;
      }
      
      const id = document.getElementById('member-id').value;
      const data = {
        name: document.getElementById('member-name').value,
        business_name: document.getElementById('member-business').value,
        email: document.getElementById('member-email').value,
        phone: document.getElementById('member-phone').value,
        linkedin: document.getElementById('member-linkedin').value || null,
        instagram: document.getElementById('member-instagram').value || null
      };
      
      try {
        const btn = event.target.querySelector('button[type="submit"]');
        btn.disabled = true;
        
        if (id) {
          const result = await supabaseClient.from('members').update(data).eq('id', id);
          if (result.error) throw result.error;
          showToast('Member updated ‚úì', 'success');
        } else {
          const result = await supabaseClient.from('members').insert([data]);
          if (result.error) throw result.error;
          showToast('Member added ‚úì', 'success');
        }
        
        await loadData();
        closeModal();
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      } finally {
        event.target.querySelector('button[type="submit"]').disabled = false;
      }
    }

    async function saveKpi(e) {
      e.preventDefault();
      if (!supabaseClient) {
        showToast('Database not initialized', 'error');
        return;
      }
      
      const id = document.getElementById('kpi-id').value;
      const data = {
        item: document.getElementById('kpi-item').value,
        kriteria: document.getElementById('kpi-kriteria').value,
        interval: document.getElementById('kpi-interval').value
      };
      
      try {
        const btn = event.target.querySelector('button[type="submit"]');
        btn.disabled = true;
        
        if (id) {
          const result = await supabaseClient.from('kpi_templates').update(data).eq('id', id);
          if (result.error) throw result.error;
          showToast('KPI updated ‚úì', 'success');
        } else {
          const result = await supabaseClient.from('kpi_templates').insert([data]);
          if (result.error) throw result.error;
          showToast('KPI created ‚úì', 'success');
        }
        
        await loadData();
        closeModal();
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      } finally {
        event.target.querySelector('button[type="submit"]').disabled = false;
      }
    }

    async function saveAssignment(e) {
      e.preventDefault();
      if (!supabaseClient) {
        showToast('Database not initialized', 'error');
        return;
      }
      
      const data = {
        member_id: document.getElementById('assignment-member').value,
        kpi_id: document.getElementById('assignment-kpi').value,
        target: parseInt(document.getElementById('assignment-target').value),
        current: 0,
        points: 0
      };
      
      try {
        const btn = event.target.querySelector('button[type="submit"]');
        btn.disabled = true;
        
        const result = await supabaseClient.from('assignments').insert([data]);
        if (result.error) throw result.error;
        
        showToast('KPI assigned ‚úì', 'success');
        await loadData();
        closeModal();
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      } finally {
        event.target.querySelector('button[type="submit"]').disabled = false;
      }
    }

    // Delete Functions with inline confirmation
    let deleteConfirmation = { type: null, id: null };

    function showDeleteConfirm(type, id, message) {
      deleteConfirmation = { type, id };
      
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      
      toast.className = 'fixed bottom-4 right-4 z-50 bg-red-600 text-white px-6 py-4 rounded-xl shadow-lg max-w-sm';
      toast.innerHTML = `
        <p class="mb-3 text-sm">${message}</p>
        <div class="flex gap-2">
          <button onclick="cancelDelete()" class="flex-1 px-3 py-2 bg-red-700 rounded hover:bg-red-800 text-sm font-medium">Cancel</button>
          <button onclick="confirmDelete('${type}', '${id}')" class="flex-1 px-3 py-2 bg-white text-red-600 rounded hover:bg-gray-100 text-sm font-medium">Delete</button>
        </div>
      `;
      
      container.appendChild(toast);
      toast.id = 'delete-confirm-toast';
    }

    function cancelDelete() {
      const toast = document.getElementById('delete-confirm-toast');
      if (toast) toast.remove();
      deleteConfirmation = { type: null, id: null };
    }

    async function confirmDelete(type, id) {
      if (!supabaseClient) {
        showToast('Database not initialized', 'error');
        return;
      }

      const toast = document.getElementById('delete-confirm-toast');
      if (toast) toast.remove();

      try {
        if (type === 'member') {
          await supabaseClient.from('assignments').delete().eq('member_id', id);
          const result = await supabaseClient.from('members').delete().eq('id', id);
          if (result.error) throw result.error;
          showToast('Member deleted ‚úì', 'success');
        } else if (type === 'kpi') {
          await supabaseClient.from('assignments').delete().eq('kpi_id', id);
          const result = await supabaseClient.from('kpi_templates').delete().eq('id', id);
          if (result.error) throw result.error;
          showToast('KPI deleted ‚úì', 'success');
        } else if (type === 'assignment') {
          const result = await supabaseClient.from('assignments').delete().eq('id', id);
          if (result.error) throw result.error;
          showToast('Assignment removed ‚úì', 'success');
        }
        
        await loadData();
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      }

      deleteConfirmation = { type: null, id: null };
    }

    function deleteMember(id) {
      showDeleteConfirm('member', id, 'üóëÔ∏è Delete this member and all their assignments?');
    }

    function deleteKpi(id) {
      showDeleteConfirm('kpi', id, 'üóëÔ∏è Delete this KPI? All assignments will also be removed.');
    }

    function deleteAssignment(id) {
      showDeleteConfirm('assignment', id, 'üóëÔ∏è Remove this assignment?');
    }

    // KPI Update
    function loadMemberKpis() {
      const memberId = document.getElementById('member-select').value;
      const list = document.getElementById('kpi-update-list');
      
      if (!memberId) {
        list.innerHTML = '<p class="text-center py-12" style="color: var(--text-secondary);">Select a member to view their KPIs</p>';
        return;
      }
      
      const memberAssignments = assignments.filter(a => a.member_id === memberId);
      
      if (memberAssignments.length === 0) {
        list.innerHTML = '<p class="text-center py-12" style="color: var(--text-secondary);">No KPI assignments for this member</p>';
        return;
      }
      
      list.innerHTML = memberAssignments.map(a => {
        const kpi = kpis.find(k => k.id === a.kpi_id);
        if (!kpi) return '';
        
        return `
          <div class="card rounded-2xl border p-4 lg:p-6">
            <h4 class="font-semibold mb-3 lg:mb-4 text-sm lg:text-base">${kpi.item}</h4>
            <div class="grid grid-cols-2 lg:grid-cols-3 gap-2 lg:gap-4 mb-3 lg:mb-4">
              <div>
                <p class="text-xs" style="color: var(--text-secondary);">Kriteria</p>
                <p class="font-semibold text-xs lg:text-sm">${kpi.kriteria}</p>
              </div>
              <div>
                <p class="text-xs" style="color: var(--text-secondary);">Interval</p>
                <p class="font-semibold text-xs lg:text-sm">${kpi.interval}</p>
              </div>
              <div>
                <p class="text-xs" style="color: var(--text-secondary);">Target</p>
                <p class="font-semibold text-xs lg:text-sm">${a.target} pts</p>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-2 lg:gap-4 mb-3 lg:mb-4">
              <div>
                <label class="text-xs lg:text-sm font-medium">Achievement</label>
                <input type="number" id="current-${a.id}" min="0" max="${a.target}" value="${a.current || 0}" class="w-full px-2 lg:px-3 py-1 lg:py-2 rounded-lg border mt-1 text-xs lg:text-base">
              </div>
              <div>
                <label class="text-xs lg:text-sm font-medium">Points</label>
                <input type="number" id="points-${a.id}" min="0" max="${a.target}" value="${a.points || 0}" class="w-full px-2 lg:px-3 py-1 lg:py-2 rounded-lg border mt-1 text-xs lg:text-base">
              </div>
            </div>
            <button onclick="updateKpiProgress('${a.id}')" class="w-full btn-primary px-3 lg:px-4 py-2 rounded-lg font-medium text-xs lg:text-base">Save Update</button>
          </div>
        `;
      }).join('');
    }

    async function updateKpiProgress(assignmentId) {
      if (!supabaseClient) {
        showToast('Database not initialized', 'error');
        return;
      }
      
      const current = parseInt(document.getElementById(`current-${assignmentId}`).value);
      const points = parseInt(document.getElementById(`points-${assignmentId}`).value);
      
      try {
        const result = await supabaseClient.from('assignments').update({ current, points }).eq('id', assignmentId);
        if (result.error) throw result.error;
        
        showToast('Progress updated ‚úì', 'success');
        await loadData();
        loadMemberKpis();
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      }
    }

    // Render Functions
    function renderAll() {
      renderStats();
      renderDashboard();
      renderMembers();
      renderKpis();
      renderAssignments();
      updateMemberSelects();
    }

    function renderStats() {
      document.getElementById('stat-members').textContent = members.length;
      document.getElementById('stat-kpis').textContent = kpis.length;
      document.getElementById('stat-assignments').textContent = assignments.length;
    }

    function renderDashboard() {
      const leaderboard = document.getElementById('leaderboard');
      if (members.length === 0) {
        leaderboard.innerHTML = '<p class="text-center py-12 text-sm lg:text-base" style="color: var(--text-secondary);">No data yet</p>';
        return;
      }
      
      const memberPoints = members.map(m => ({
        member: m,
        points: assignments.filter(a => a.member_id === m.id).reduce((sum, a) => sum + (a.points || 0), 0)
      })).sort((a, b) => b.points - a.points);
      
      leaderboard.innerHTML = memberPoints.map((item, i) => `
        <div class="flex items-center justify-between p-3 lg:p-4 rounded-xl card gap-2">
          <div class="flex items-center gap-2 lg:gap-4 flex-1 min-w-0">
            <span class="text-lg lg:text-xl flex-shrink-0">${i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : i + 1}</span>
            <div class="min-w-0">
              <p class="font-semibold text-xs lg:text-base truncate">${item.member.name}</p>
              <p class="text-xs" style="color: var(--text-secondary); truncate;">${item.member.business_name}</p>
            </div>
          </div>
          <p class="text-xl lg:text-2xl font-bold flex-shrink-0" style="color: var(--accent);">${item.points}/100</p>
        </div>
      `).join('');
    }

    function editMember(id) {
      const member = members.find(m => m.id === id);
      if (!member) {
        showToast('Member not found', 'error');
        return;
      }
      
      document.getElementById('member-id').value = member.id || '';
      document.getElementById('member-name').value = member.name || '';
      document.getElementById('member-business').value = member.business_name || '';
      document.getElementById('member-email').value = member.email || '';
      document.getElementById('member-phone').value = member.phone || '';
      document.getElementById('member-linkedin').value = member.linkedin || '';
      document.getElementById('member-instagram').value = member.instagram || '';
      document.getElementById('member-modal-title').textContent = 'Edit Member';
      document.getElementById('member-modal').classList.remove('hidden');
    }

    function editKpi(id) {
      const kpi = kpis.find(k => k.id === id);
      if (!kpi) {
        showToast('KPI not found', 'error');
        return;
      }
      
      document.getElementById('kpi-id').value = kpi.id || '';
      document.getElementById('kpi-item').value = kpi.item || '';
      document.getElementById('kpi-kriteria').value = kpi.kriteria || '';
      document.getElementById('kpi-interval').value = kpi.interval || '';
      document.getElementById('kpi-modal-title').textContent = 'Edit KPI';
      document.getElementById('kpi-modal').classList.remove('hidden');
    }

    function renderMembers() {
      const list = document.getElementById('members-list');
      if (members.length === 0) {
        list.innerHTML = '<p class="col-span-full text-center py-12" style="color: var(--text-secondary);">No members yet</p>';
        return;
      }
      
      list.innerHTML = members.map(m => {
        const memberAssignments = assignments.filter(a => a.member_id === m.id);
        const totalPoints = memberAssignments.reduce((sum, a) => sum + (a.points || 0), 0);
        const percentage = Math.min((totalPoints / 100) * 100, 100);
        
        return `
          <div class="card rounded-2xl border p-6">
            <div class="flex justify-between items-start mb-4">
              <div>
                <h4 class="font-semibold text-lg">${m.name}</h4>
                <p class="text-sm" style="color: var(--text-secondary);">${m.business_name}</p>
                <p class="text-xs" style="color: var(--text-secondary); margin-top: 0.25rem;">${m.email} ‚Ä¢ ${m.phone}</p>
                <div class="flex gap-2 mt-3">
                  ${m.linkedin ? `<a href="${m.linkedin}" target="_blank" rel="noopener noreferrer" class="text-blue-600 text-xs">üîó LinkedIn</a>` : ''}
                  ${m.instagram ? `<a href="https://instagram.com/${m.instagram.replace('@', '')}" target="_blank" rel="noopener noreferrer" class="text-pink-600 text-xs">üì∏ Instagram</a>` : ''}
                </div>
              </div>
              <div class="flex gap-2">
                <button onclick="editMember('${m.id}')" class="p-2 rounded-lg hover:opacity-80" style="background-color: rgba(59, 130, 246, 0.2); color: var(--accent);">ÔøΩÔøΩÔøΩÔøΩ</button>
                <button onclick="deleteMember('${m.id}')" class="p-2 rounded-lg hover:opacity-80" style="background-color: rgba(239, 68, 68, 0.2); color: var(--error);">üóëÔ∏è</button>
              </div>
            </div>
            <div class="flex justify-between text-sm mb-2">
              <span style="color: var(--text-secondary);">Points</span>
              <span class="font-bold">${totalPoints}/100</span>
            </div>
            <div class="h-2 rounded-full" style="background-color: var(--bg-tertiary); overflow: hidden;">
              <div class="progress-bar h-full rounded-full" style="width: ${percentage}%"></div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderKpis() {
      const list = document.getElementById('kpis-list');
      if (kpis.length === 0) {
        list.innerHTML = '<p class="text-center py-12" style="color: var(--text-secondary);">No KPIs yet</p>';
        return;
      }
      
      list.innerHTML = kpis.map(k => `
        <div class="card rounded-2xl border p-6 flex justify-between items-start">
          <div>
            <h4 class="font-semibold">${k.item}</h4>
            <p class="text-sm" style="color: var(--text-secondary); margin-top: 0.25rem;">${k.kriteria} ‚Ä¢ ${k.interval}</p>
          </div>
          <div class="flex gap-2">
            <button onclick="editKpi('${k.id}')" class="p-2 rounded-lg hover:opacity-80" style="background-color: rgba(59, 130, 246, 0.2); color: var(--accent);">‚úèÔ∏è</button>
            <button onclick="deleteKpi('${k.id}')" class="p-2 rounded-lg hover:opacity-80" style="background-color: rgba(239, 68, 68, 0.2); color: var(--error);">üóëÔ∏è</button>
          </div>
        </div>
      `).join('');
    }

    function renderAssignments() {
      const list = document.getElementById('assignments-list');
      if (assignments.length === 0) {
        list.innerHTML = '<p class="text-center py-12" style="color: var(--text-secondary);">No assignments yet</p>';
        return;
      }
      
      list.innerHTML = assignments.map(a => {
        const m = members.find(x => x.id === a.member_id);
        const k = kpis.find(x => x.id === a.kpi_id);
        if (!m || !k) return '';
        
        return `
          <div class="card rounded-2xl border p-6">
            <div class="flex justify-between items-start mb-3">
              <div>
                <p class="font-semibold">${m.name}</p>
                <p class="text-sm" style="color: var(--text-secondary);">${k.item}</p>
              </div>
              <button onclick="deleteAssignment('${a.id}')" class="p-2 rounded-lg hover:opacity-80" style="background-color: rgba(239, 68, 68, 0.2); color: var(--error);">üóëÔ∏è</button>
            </div>
            <div class="flex justify-between text-sm">
              <span style="color: var(--text-secondary);">Points</span>
              <span class="font-bold">${a.points || 0}/${a.target}</span>
            </div>
          </div>
        `;
      }).join('');
    }

    function updateMemberSelects() {
      const select = document.getElementById('member-select');
      select.innerHTML = '<option value="">Choose member...</option>';
      members.forEach(m => select.innerHTML += `<option value="${m.id}">${m.name}</option>`);
    }

    // Toast
    function showToast(msg, type = 'info') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      const bgColor = type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--error)' : 'var(--accent)';
      
      toast.className = 'toast text-white px-6 py-3 rounded-xl shadow-lg';
      toast.style.backgroundColor = bgColor;
      toast.textContent = msg;
      
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      await initSupabase();
      await loadData();
    });

    if (document.readyState !== 'loading') {
      initSupabase();
    }
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9cb99af3537344b7',t:'MTc3MDcwNTUyNC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
